{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/mats/Code/react-parallel-reader/app/api/highlights/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport fs from 'fs';\nimport path from 'path';\n\nexport const dynamic = 'force-dynamic';\n\n// Interface matching the front-end structure we will use\ninterface Highlight {\n    id: string;\n    cfiRange: string;\n    text: string;\n    bookUrl: string;\n    color?: string;\n    created: number;\n}\n\n// Helper to get highlight path from a book URL\n// bookUrl example: \"/books/alice.epub\" or \"/books/collection-a/book.epub\"\nfunction getHighlightPath(bookUrl: string): string | null {\n    if (!bookUrl) return null;\n\n    // Remove leading slash if present for path joining\n    const safeUrl = bookUrl.startsWith('/') ? bookUrl.slice(1) : bookUrl;\n\n    // Get the directory of the book\n    // public/books/alice.epub -> public/books\n    // public/books/collection/alice.epub -> public/books/collection\n    const bookDir = path.dirname(safeUrl);\n\n    return path.join(process.cwd(), 'public', bookDir, 'highlights.json');\n}\n\n// GET: Retrieve all highlights for the requested books\nexport async function GET(req: Request) {\n    try {\n        const { searchParams } = new URL(req.url);\n        const urlsParam = searchParams.get('urls');\n\n        if (!urlsParam) {\n            // Fallback to global if no urls provided, or return empty?\n            // For backward compatibility during migration, we could check global, \n            // but let's stick to the plan of collection-based.\n            // If no URLs, we can't know where to look, so return empty.\n            return NextResponse.json([]);\n        }\n\n        const urls = urlsParam.split(',').filter(Boolean);\n        let allHighlights: Highlight[] = [];\n\n        // We need to deduplicate paths to avoid reading same file twice\n        // (though unlikely if urls are distinct books in same dir)\n        const pathsToCheck = new Set<string>();\n\n        urls.forEach(url => {\n            const p = getHighlightPath(url);\n            if (p) pathsToCheck.add(p);\n        });\n\n        for (const highlightPath of pathsToCheck) {\n            if (fs.existsSync(highlightPath)) {\n                try {\n                    const fileContent = fs.readFileSync(highlightPath, 'utf-8');\n                    const fileHighlights: Highlight[] = JSON.parse(fileContent);\n                    allHighlights = allHighlights.concat(fileHighlights);\n                } catch (e) {\n                    console.error(`Error reading highlights from ${highlightPath}:`, e);\n                }\n            }\n        }\n\n        return NextResponse.json(allHighlights);\n    } catch (error) {\n        console.error('Error reading highlights:', error);\n        return NextResponse.json([]);\n    }\n}\n\n// POST: Save a new highlight\nexport async function POST(req: Request) {\n    try {\n        const newHighlight: Highlight = await req.json();\n\n        if (!newHighlight.bookUrl) {\n            return NextResponse.json({ error: 'bookUrl is required' }, { status: 400 });\n        }\n\n        const highlightPath = getHighlightPath(newHighlight.bookUrl);\n\n        if (!highlightPath) {\n            return NextResponse.json({ error: 'Invalid bookUrl' }, { status: 400 });\n        }\n\n        let highlights: Highlight[] = [];\n\n        // Ensure directory exists (it should, since the book exists there, but good practice)\n        // actually we assume the book folders exist. \n\n        if (fs.existsSync(highlightPath)) {\n            const fileContent = fs.readFileSync(highlightPath, 'utf-8');\n            try {\n                highlights = JSON.parse(fileContent);\n            } catch (e) {\n                // if corrupt, start fresh\n                highlights = [];\n            }\n        }\n\n        highlights.push(newHighlight);\n        fs.writeFileSync(highlightPath, JSON.stringify(highlights, null, 2));\n\n        return NextResponse.json({ success: true, highlights });\n    } catch (error) {\n        console.error('Error saving highlight:', error);\n        return NextResponse.json({ error: 'Failed to save highlight' }, { status: 500 });\n    }\n}\n\n// DELETE: Remove a highlight\nexport async function DELETE(req: Request) {\n    try {\n        // We need bookUrl to know which file to modify\n        const { id, bookUrl } = await req.json();\n\n        if (!bookUrl) {\n            return NextResponse.json({ error: 'bookUrl is required for deletion' }, { status: 400 });\n        }\n\n        const highlightPath = getHighlightPath(bookUrl);\n        if (!highlightPath || !fs.existsSync(highlightPath)) {\n            return NextResponse.json({ success: false, message: \"No highlight file found\" });\n        }\n\n        const fileContent = fs.readFileSync(highlightPath, 'utf-8');\n        let highlights: Highlight[] = JSON.parse(fileContent);\n\n        const initialLength = highlights.length;\n        highlights = highlights.filter(h => h.id !== id);\n\n        if (highlights.length === initialLength) {\n            return NextResponse.json({ success: false, message: \"Highlight not found\" });\n        }\n\n        fs.writeFileSync(highlightPath, JSON.stringify(highlights, null, 2));\n        return NextResponse.json({ success: true, highlights });\n\n    } catch (error) {\n        console.error('Error deleting highlight:', error);\n        return NextResponse.json({ error: 'Failed to delete' }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":"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"}}]
}